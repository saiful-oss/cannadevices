{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign pick_up_availabilities = current_variant.store_availabilities | where: 'pick_up_enabled', true
-%}
{%- if pick_up_availabilities.size > 0 -%}
  <pickup-availability class="pickup__preview pickup__preview--primary">
    {%- assign closest_location = pick_up_availabilities.first -%}

    <div class="pickup__info">
      {%- if closest_location.available -%}
        <p class="pickup__info__text">
          {{ 'products.product.pickup_availability.pick_up_available_at_html' | t: location_name: closest_location.location.name }}
          {%- render 'icon-in-stock' -%}
        </p>
        <p>
          <span class="pickup__info__timing">{{ closest_location.pick_up_time }} â€” </span>
          <button id="ShowPickupAvailabilityDrawer" class="pickup__button text-link" aria-haspopup="dialog" data-pickup-drawer-open>
            {%- if pick_up_availabilities.size == 1 -%}
              {{ 'products.product.pickup_availability.view_store_info' | t }}
            {%- else -%}
              {{ 'products.product.pickup_availability.check_other_stores' | t }}
            {%- endif -%}
          </button>
        </p>
      {%- else -%}
        <p class="pickup__info__text">
          {{ 'products.product.pickup_availability.pick_up_unavailable_at_html' | t: location_name: closest_location.location.name }}
          {%- render 'icon-out-of-stock' -%}
        </p>
        {%- if pick_up_availabilities.size > 1 -%}
          <button id="ShowPickupAvailabilityDrawer" class="pickup__button text-link" aria-haspopup="dialog" data-pickup-drawer-open>
            {{ 'products.product.pickup_availability.check_other_stores' | t }}
          </button>
        {%- endif -%}
      {%- endif -%}
    </div>

    <div tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="PickupAvailabilityHeading" class="pickup__drawer drawer drawer--right" data-pickup-drawer>
      <div class="pickup__content drawer__content" data-pickup-body data-scroll-lock-scrollable>
        <div class="drawer__top pickup__header">
          <div class="pickup__header__title" id="PickupAvailabilityHeading">
            {{ 'products.product.pickup_availability.pickup_options' | t }}
          </div>

          <button
            class="drawer__button drawer__close"
            data-pickup-drawer-close
            aria-label="{{ 'general.accessibility.close' | t }}"
          >
            {% render 'icon-close' %}
          </button>
        </div>

        <div class="pickup__drawer__body">
          <div class="pickup__product__wrap">
            <p class="pickup__product__title">
              {{ product.title | escape }}
            </p>
            {%- unless product.has_only_default_variant -%}
              <p class="pickup__variant">
                {%- for product_option in product.options_with_values -%}
                  <span class="badge">
                    <span class="text-light">{{ product_option.name | escape }}</span><span class="divide">&nbsp;|&nbsp;</span>
                    {%- for value in product_option.values -%}
                      {%- if product_option.selected_value == value -%}
                        {{ value | escape }}
                      {%- endif -%}
                    {%- endfor -%}
                  </span>
                {%- endfor -%}
              </p>
            {%- endunless -%}
          </div>

          <ul class="pickup__list list-unstyled" role="list">
            {%- for availability in pick_up_availabilities -%}
              <li class="pickup__list__item">
                <p class="h5--body">
                  <strong>
                    {{ availability.location.name | escape }}
                  </strong>
                  {%- if availability.available -%}
                    {% render 'icon-in-stock' %}
                  {%- else -%}
                    {% render 'icon-out-of-stock' %}
                  {%- endif -%}
                </p>
                <p class="pickup__list__item__info">
                  {%- if availability.available -%}
                    {{ 'products.product.pickup_availability.pick_up_available' | t }}, {{ availability.pick_up_time | downcase }}
                  {%- endif -%}
                </p>

                {%- assign address = availability.location.address -%}
                <address class="pickup__address">
                  {{ address | format_address }}

                  {%- if address.phone.size > 0 -%}
                    <p>{{ address.phone }}</p>
                  {%- endif -%}
                </address>
              </li>
            {%- endfor -%}
          </ul>
        </div>
      </div>

      <span class="drawer__underlay" data-drawer-underlay data-pickup-drawer-close>
        <span class="drawer__underlay__fill"></span>
        <span class="drawer__underlay__blur"></span>
      </span>
    </div>
  </pickup-availability>
{%- endif -%}
