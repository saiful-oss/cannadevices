<!-- /snippets/product-subscription.liquid -->

{%- if product.selling_plan_groups.size > 0 -%}
  {% liquid
    assign current_variant = product.selected_or_first_available_variant
  %}

  <div class="product__subs__wrap">
    <fieldset class="product__subs">
      {% comment %}
        The input with name="selling_plan" submits to cart
        <input type="hidden" name="selling_plan" value="{{ product.selected_selling_plan.id }}" />
      {% endcomment %}
      <legend class="visually-hidden">{{ 'products.product.subscription' | t }}</legend>

      {% unless product.requires_selling_plan %}
        {%- capture variant_url_without_selling_plan -%}
          {%- render 'product-form-variant-url',
            product: product,
            variant: current_variant,
            selling_plan: false
          -%}
        {%- endcapture -%}

        <div class="product__subs__group">
          <label class="product__subs__option">
            <input
              type="radio"
              name="selling-plan-group"
              value=""
              @change="
                if ($el.closest('[data-enable-history-state]')?.dataset.enableHistoryState == 'false') {
                  await $sectionApi.navigate('{{- request.origin | append: variant_url_without_selling_plan -}}', 'none');
                } else {
                  await $sectionApi.navigate('{{- request.origin | append: variant_url_without_selling_plan -}}', 'replace');
                }
              "
              {% unless product.selected_selling_plan %}
                checked
              {% endunless %}
            >
            <span>{{ 'products.product.one_time_purchase' | t }}</span>
          </label>
        </div>
      {% endunless %}

      {% comment %} Use the first selling plan of the first group if no selected selling plan{% endcomment %}
      {%- unless product.selected_selling_plan -%}
        {%- assign first_selling_group = product.selling_plan_groups[0] -%}
        {%- assign first_selling_plan = first_selling_group.selling_plans[0] -%}
      {%- endunless -%}

      {% for selling_plan_group in product.selling_plan_groups %}
        {%- assign preselected = false -%}
        {% if selling_plan_group.selling_plan_selected %}
          {%- assign preselected = true -%}
        {%- elsif product.requires_selling_plan and first_selling_group.id == selling_plan_group.id -%}
          {%- assign preselected = true -%}
        {% endif %}

        {%- capture variant_url_with_selling_plan_group -%}
          {%- render 'product-form-variant-url',
            product: product,
            variant: current_variant,
            selling_plan: selling_plan_group.selling_plans[0]
          -%}
        {%- endcapture -%}

        <div class="product__subs__group">
          <label class="product__subs__option">
            <input
              type="radio"
              name="selling-plan-group"
              value="{{ selling_plan_group.id }}"
              @change="
                if ($el.closest('[data-enable-history-state]')?.dataset.enableHistoryState == 'false') {
                  await $sectionApi.navigate('{{- request.origin | append: variant_url_with_selling_plan_group -}}', 'none');
                } else {
                  await $sectionApi.navigate('{{- request.origin | append: variant_url_with_selling_plan_group -}}', 'replace');
                }
              "
              {% if preselected %}
                checked
              {% endif %}
            >
            <span>{{ selling_plan_group.name }}</span>
          </label>

          <div class="product__subs__plans {% unless preselected %} hide{% endunless %}">
            {% for plan in selling_plan_group.selling_plans %}
              {%- capture variant_url_with_selling_plan -%}
                {%- render 'product-form-variant-url',
                  product: product,
                  variant: current_variant,
                  selling_plan: plan
                -%}
              {%- endcapture -%}

              <label class="product__subs__option">
                <input
                  type="radio"
                  name="selling_plan"
                  value="{{ plan.id }}"
                  @change="
                    if ($el.closest('[data-enable-history-state]')?.dataset.enableHistoryState == 'false') {
                      await $sectionApi.navigate('{{- request.origin | append: variant_url_with_selling_plan -}}', 'none');
                    } else {
                      await $sectionApi.navigate('{{- request.origin | append: variant_url_with_selling_plan -}}', 'replace');
                    }
                  "
                  {% if plan.selected %}
                    checked
                  {%- elsif product.requires_selling_plan and first_selling_plan.id == plan.id -%}
                    checked
                  {% endif %}
                >
                <span>{{ plan.name }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </fieldset>

    {% if product.selected_selling_plan.description != blank %}
      <p class="product__subs__description {% unless product.selected_selling_plan %} hide{% endunless %}">
        {{ product.selected_selling_plan.description }}
      </p>
    {% endif %}
  </div>
{% endif %}
